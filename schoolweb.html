<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pibble Clicker!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background-color: #010619;
            background-image: radial-gradient(at 50% 10%, #1e3a8a, #0b1a3d, #030712);
            position: relative;
            font-family: 'Inter', sans-serif;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(2px 2px at 20px 30px, #fff, rgba(255, 255, 255, 0)),
                radial-gradient(2px 2px at 80px 100px, #fff, rgba(255, 255, 255, 0)),
                radial-gradient(3px 3px at 150px 150px, #fff, rgba(255, 255, 255, 0)),
                radial-gradient(2px 2px at 200px 70px, #fff, rgba(255, 255, 255, 0)),
                radial-gradient(1px 1px at 300px 200px, #fff, rgba(255, 255, 255, 0));
            background-size: 300px 300px;
            opacity: 0.6;
            animation: twinkle 15s infinite alternate;
            pointer-events: none;
            z-index: 1; 
        }

        @keyframes twinkle {
            0% { opacity: 0.6; }
            100% { opacity: 0.8; }
        }

        #clicker-square {
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
            cursor: pointer;
            user-select: none;
            will-change: transform;
            object-fit: contain;
            position: relative; 
            z-index: 30; 
            filter: drop-shadow(0 0 20px rgba(100, 149, 237, 0.7));
        }

        .clicked {
            transform: scale(0.9) rotate(-10deg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        }

        @keyframes strong-wind-left {
            0% { transform: translateX(0) scaleX(1); opacity: 0.8; }
            100% { transform: translateX(30%) scaleX(0.05); opacity: 0; }
        }
        @keyframes strong-wind-right {
            0% { transform: translateX(0) scaleX(1); opacity: 0.8; }
            100% { transform: translateX(-30%) scaleX(0.05); opacity: 0; }
        }

        .wind-line {
            position: absolute;
            width: 120px; 
            height: 4px;
            background: rgba(173, 216, 230, 0.8);
            border-radius: 2px;
            pointer-events: none;
            z-index: 20; 
        }
        .wind-line.left { animation: strong-wind-left 0.7s infinite linear; transform-origin: left center; }
        #line-1 { top: 15%; left: -30%; animation-delay: 0s; }
        #line-2 { top: 45%; left: -20%; animation-delay: 0.2s; width: 100px; }
        #line-3 { top: 75%; left: -35%; animation-delay: 0.4s; width: 140px; }
        .wind-line.right { animation: strong-wind-right 0.7s infinite linear; transform-origin: right center; }
        #line-4 { top: 15%; right: -30%; animation-delay: 0.1s; }
        #line-5 { top: 45%; right: -20%; animation-delay: 0.3s; width: 100px; }
        #line-6 { top: 75%; right: -35%; animation-delay: 0.5s; width: 140px; }

        .golden-sponge {
            position: fixed; 
            width: 70px;
            height: 70px;
            cursor: pointer;
            transition: opacity 0.3s, transform 0.1s;
            z-index: 100; 
            filter: drop-shadow(0 0 20px rgba(255, 223, 0, 1)) saturate(1.8);
        }
        .golden-sponge:active {
            transform: scale(0.85) !important;
        }

        #boost-timer {
            background: linear-gradient(135deg, #ffdd57 0%, #ff4500 100%);
            color: #0b1a3d;
            border: 3px solid #ffd700;
            box-shadow: 0 0 25px rgba(255, 215, 0, 1);
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            animation: pulse-boost 1s infinite alternate;
        }

        @keyframes pulse-boost {
            from { transform: scale(1); box-shadow: 0 0 25px rgba(255, 215, 0, 1); }
            to { transform: scale(1.05); box-shadow: 0 0 35px rgba(255, 215, 0, 1.2); }
        }
        
        #store-section {
            background: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(5px);
            border: 2px solid #1f3d8a;
            max-width: 600px;
            margin: 3rem auto 2rem auto;
        }
        
        @media (min-width: 1024px) {
            #store-section {
                max-width: 800px;
            }
        }
        
        .modal {
            background: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            background: #0b1a3d;
            border: 3px solid #1e3a8a;
            box-shadow: 0 0 30px rgba(30, 58, 138, 0.7);
            animation: slide-down 0.3s ease-out;
        }
        @keyframes slide-down {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        #rebirth-section {
            background: rgba(49, 46, 129, 0.85);
            border: 2px solid #6366f1;
            box-shadow: 0 0 25px rgba(99, 102, 241, 0.6);
        }

        .rebirth-button {
            background-color: #f87171;
            color: #4338ca;
            transition: background-color 0.15s, transform 0.1s;
        }
        .rebirth-button:hover:not(:disabled) {
            background-color: #ef4444;
            transform: scale(1.03);
        }
        .rebirth-button:active:not(:disabled) {
            transform: scale(0.98);
        }
        .rebirth-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #f87171;
        }

        #flappy-game {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 300px;
            border: 2px solid #1e3a8a;
            background: #87ceeb;
            z-index: 50;
            
            box-shadow: 0 0 20px rgba(30, 58, 138, 0.7);
            overflow: hidden;
        }
        #flappy-canvas {
            width: 100%;
            height: 100%;
            display: block;
            background-color: #87ceeb;
        }
        
        .flappy-reward-button {
            background-color: #38a169;
            color: white;
            font-weight: bold;
            transition: background-color 0.15s;
        }
        .flappy-reward-button:disabled {
            background-color: #38a169;
            opacity: 0.7;
            cursor: default;
        }
    </style>
</head>
<body class="text-white flex flex-col items-center min-h-screen p-4 z-10 relative">

    <div id="boost-timer" class="fixed top-4 left-4 p-3 rounded-xl shadow-lg font-extrabold hidden z-50">
        <p class="text-lg">3X BOOST ACTIVE</p>
        <p class="text-3xl font-mono text-center" id="boost-countdown">30.0s</p>
    </div>
    
    <div id="flappy-game" class="hidden">
        <canvas id="flappy-canvas" width="200" height="300"></canvas>
    </div>
    
    <div class="w-full max-w-7xl flex flex-col items-center z-20">

        <header class="w-full flex justify-center items-start pt-6 pb-8 relative">
            
            <div id="money-box" class="absolute left-0 top-6 ml-4 hidden sm:block">
                <p class="text-xl font-medium text-blue-300">PibbCoins:</p>
                <p id="money-display" class="text-5xl font-mono text-lime-400 text-shadow-lg">
                    0
                </p>
            </div>

            <div class="flex flex-col items-center text-center pointer-events-none">
                <div class="flex justify-center items-center">
                    <div class="w-10 h-10 bg-amber-500 rounded-lg shadow-xl flex items-center justify-center p-1 pointer-events-auto border-2 border-amber-300 mr-2">
                        <img
                            src="https://raw.githubusercontent.com/ILoveGothsAndChicken/A-School/main/Pibble%20coin.png"
                            alt="Pibble Coin Icon"
                            class="w-full h-full object-contain"
                        />
                    </div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-blue-300 sm:text-4xl pointer-events-auto">
                        The Pibble Clicker
                    </h1>
                </div>
                
                <div id="pcs-box" class="flex items-baseline space-x-2 mt-4 pointer-events-auto">
                    <p class="text-2xl font-bold text-fuchsia-300">PCS:</p>
                    <p id="pcs-display" class="text-3xl font-mono text-fuchsia-400">
                        0
                    </p>
                </div>
                
            </div>

            <div class="absolute right-0 top-6 mr-4 flex flex-col items-end">
                
                <button id="flappy-toggle-button" class="p-2 rounded-full bg-green-700 hover:bg-green-600 transition duration-150 z-50 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-300" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 6a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zm1 3h10a1 1 0 110 2H5a1 1 0 110-2zM4 12a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zm1 3h10a1 1 0 110 2H5a1 1 0 110-2z"/>
                        <path fill-rule="evenodd" d="M10 18a.5.5 0 01-.5-.5v-4a.5.5 0 011 0v4a.5.5 0 01-.5.5z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <button id="settings-button" class="p-2 rounded-full bg-blue-700 hover:bg-blue-600 transition duration-150 z-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.493 3.518c-.856-1.026-2.522-1.026-3.377 0C7.26 4.606 6.51 6.136 5.59 7.37c-.783 1.047-2.31 1.047-3.093 0-.92-.816-1.527-1.847-1.745-3.016.086-1.127.848-1.996 2.012-2.17.653-.13 1.32-.178 2.016-.013 1.037.247 1.83.693 2.51 1.41a3.03 3.03 0 014.288 0c.68-.717 1.473-1.163 2.51-1.41 1.037-.247 1.776.083 2.012 1.178.218 1.169-.485 2.199-1.268 3.016-.92 1.234-1.67 2.764-2.59 3.998-.783 1.047-2.31 1.047-3.093 0-.92-1.234-1.67-2.764-2.59-3.998-.783 1.047-2.31 1.047-3.093 0-1.037 1.383-1.547 2.87-1.765 4.417.086 1.544.848 2.73 2.012 3.125.653.27 1.32.404 2.016.33 1.037-.184 1.83-.55 2.51-1.08a3.03 3.03 0 014.288 0c.68.53 1.473.896 2.51 1.08 1.037.183 1.776-.002 2.012-1.125.218-1.547-.485-3.034-1.268-4.417-1.037-1.67-1.747-3.32-2.34-4.83zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div class="sm:hidden mt-2">
                    <p class="text-base font-medium text-blue-300">PibbCoins:</p>
                    <p id="money-display-mobile" class="text-2xl font-mono text-lime-400">
                        0
                    </p>
                </div>
            </div>
            
        </header>

        <main class="w-full flex flex-col items-center">
            <div id="clicker-view" class="flex justify-center items-center relative my-12 w-full max-w-lg">
                <img
                    id="clicker-square"
                    class="w-48 h-48 sm:w-64 sm:h-64 rounded-xl shadow-2xl border-4 border-blue-300 bg-gray-700 p-2 relative"
                    role="button"
                    aria-label="Click to earn money"
                    src="https://raw.githubusercontent.com/ILoveGothsAndChicken/A-School/main/Perfect.png"
                    alt="Clickable Item"
                />
                <div id="line-1" class="wind-line left"></div>
                <div id="line-2" class="wind-line left"></div>
                <div id="line-3" class="wind-line left"></div>
                <div id="line-4" class="wind-line right"></div>
                <div id="line-5" class="wind-line right"></div>
                <div id="line-6" class="wind-line right"></div>
            </div>
        </main>
        
        <div id="store-section" class="w-full p-6 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold text-blue-300 mb-6 text-center border-b pb-3 border-blue-600">Store & Upgrades</h2>
            
            <div id="store-content-container" class="space-y-6">

                <div id="pcs-increaser-item-1" class="flex flex-col sm:flex-row justify-between items-center bg-blue-700/70 p-4 rounded-lg shadow-inner shadow-blue-900/50 hover:bg-blue-600/70 transition duration-200">
                    <div class="mb-2 sm:mb-0 text-center sm:text-left">
                        <p class="text-xl font-bold">Pibble Washer I (1x PCS)</p>
                        <p class="text-sm text-fuchsia-300 font-mono mt-0.5"><span id="pcs-count-1">0</span> owned</p>
                    </div>
                    <button 
                        id="buy-pcs-increaser-1" 
                        class="buy-button w-full sm:w-auto px-6 py-2 bg-amber-500 hover:bg-amber-400 rounded-xl font-bold text-blue-900 transition duration-150 shadow-lg disabled:opacity-30 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
                        data-tier="1"
                    >
                        <span id="pcs-increaser-cost-1">50 Pibbcoins</span>
                    </button>
                </div>

                <div id="pcs-increaser-item-2" class="flex flex-col sm:flex-row justify-between items-center bg-blue-700/70 p-4 rounded-lg shadow-inner shadow-blue-900/50 hover:bg-blue-600/70 transition duration-200">
                    <div class="mb-2 sm:mb-0 text-center sm:text-left">
                        <p class="text-xl font-bold">Pibble Washer II (10x PCS)</p>
                        <p class="text-sm text-fuchsia-300 font-mono mt-0.5"><span id="pcs-count-2">0</span> owned</p>
                    </div>
                    <button 
                        id="buy-pcs-increaser-2" 
                        class="buy-button w-full sm:w-auto px-6 py-2 bg-amber-500 hover:bg-amber-400 rounded-xl font-bold text-blue-900 transition duration-150 shadow-lg disabled:opacity-30 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
                        data-tier="2"
                    >
                        <span id="pcs-increaser-cost-2">500 Pibbcoins</span>
                    </button>
                </div>

                <div id="pcs-increaser-item-3" class="flex flex-col sm:flex-row justify-between items-center bg-blue-700/70 p-4 rounded-lg shadow-inner shadow-blue-900/50 hover:bg-blue-600/70 transition duration-200">
                    <div class="mb-2 sm:mb-0 text-center sm:text-left">
                        <p class="text-xl font-bold">Pibble Washer III (100x PCS)</p>
                        <p class="text-sm text-fuchsia-300 font-mono mt-0.5"><span id="pcs-count-3">0</span> owned</p>
                    </div>
                    <button 
                        id="buy-pcs-increaser-3" 
                        class="buy-button w-full sm:w-auto px-6 py-2 bg-amber-500 hover:bg-amber-400 rounded-xl font-bold text-blue-900 transition duration-150 shadow-lg disabled:opacity-30 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
                        data-tier="3"
                    >
                        <span id="pcs-increaser-cost-3">5,000 Pibbcoins</span>
                    </button>
                </div>
                
                <h3 class="text-2xl font-bold text-blue-300 mb-4 pt-4 border-t border-blue-600 text-center">Permanent Upgrades</h3>
                <div id="perm-upgrades-container" class="space-y-4">
                                </div>
            </div>
        </div>
        
        <div id="rebirth-section" class="w-full max-w-7xl p-6 rounded-xl shadow-2xl mt-8 mb-8">
            <h2 class="text-3xl font-bold text-red-400 mb-4 text-center border-b pb-2 border-indigo-400">
                ‚ú® Rebirth
            </h2>
            
            <div id="rebirth-item-1" class="flex flex-col sm:flex-row justify-between items-center bg-indigo-900/50 p-4 rounded-lg shadow-inner shadow-indigo-900/50">
                <div class="mb-2 sm:mb-0 text-center sm:text-left">
                    <p class="text-xl font-bold text-red-300">First Rebirth: New Dawn</p>
                    <p class="text-sm text-gray-300 font-mono mt-0.5">
                        Reset Your Progress For <span class="font-bold text-red-200">3x PCS</span>
                    </p>
                </div>
                <button 
                    id="buy-rebirth-1" 
                    class="rebirth-button w-full sm:w-auto px-6 py-3 rounded-xl font-extrabold text-lg transition duration-150 shadow-lg disabled:opacity-40"
                    data-tier="1"
                >
                    <span id="rebirth-cost-1">20.0M Pibbcoins</span>
                </button>
            </div>
            
        </div>
    </div>
    
    <div id="settings-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content w-full max-w-sm p-6 rounded-xl">
            <h2 class="text-3xl font-bold text-blue-300 mb-6 text-center border-b pb-3 border-blue-600">Settings</h2>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center py-3 px-2 border-y border-gray-700">
                    <p class="text-xl font-medium text-gray-200">Auto Purchase</p>
                    <button id="toggle-auto-purchase" class="px-4 py-2 rounded-xl font-bold text-white transition duration-150 shadow-md">
                        OFF
                    </button>
                </div>
                <button id="save-button" class="w-full px-6 py-3 bg-lime-500 hover:bg-lime-400 rounded-xl font-bold text-blue-900 transition duration-150 shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                    üíæ Save
                </button>
                <button id="restart-button" class="w-full px-6 py-3 bg-red-600 hover:bg-red-500 rounded-xl font-bold text-white transition duration-150 shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                    üîÑ Restart Progress
                </button>
                <button id="close-settings" class="w-full px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded-xl font-bold text-white transition duration-150 mt-4">
                    Close
                </button>
                <p id="save-status" class="text-center text-sm text-lime-400 mt-2 opacity-0 transition duration-300"></p>
            </div>
        </div>
        
    </div>
    
    <div id="confirmation-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content w-full max-w-xs p-6 rounded-xl">
            <p id="confirmation-text" class="text-xl font-bold text-gray-200 mb-6 text-center">Are you sure you want to restart? All unsaved progress will be lost.</p>
            <div class="flex justify-between space-x-4">
                <button id="confirm-action" class="w-1/2 px-4 py-2 bg-red-600 hover:bg-red-500 rounded-xl font-bold text-white transition duration-150 shadow-lg">Yes, Restart</button>
                <button id="cancel-action" class="w-1/2 px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-xl font-bold text-white transition duration-150">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_IMAGE_SRC = "https://raw.githubusercontent.com/ILoveGothsAndChicken/A-School/main/Perfect.png";
        const CLICK_DOWN_IMAGE_SRC = "https://github.com/ILoveGothsAndChicken/A-School/raw/main/Sponge%20Pibble.png";
        const GOLDEN_SPONGE_URL = 'https://github.com/ILoveGothsAndChicken/A-School/raw/main/Golden%20sponge.png';
        const STORAGE_KEY = 'pibbleClickerSave';
        
        const moneyDisplay = document.getElementById('money-display');
        const moneyDisplayMobile = document.getElementById('money-display-mobile');
        const pcsDisplay = document.getElementById('pcs-display'); 
        const clickerSquare = document.getElementById('clicker-square');
        const boostTimer = document.getElementById('boost-timer');
        const boostCountdown = document.getElementById('boost-countdown');
        const flappyGame = document.getElementById('flappy-game'); 
        const flappyToggleButton = document.getElementById('flappy-toggle-button'); 

        const pcsIncreaserCostSpan1 = document.getElementById('pcs-increaser-cost-1');
        const pcsCountSpan1 = document.getElementById('pcs-count-1');
        const pcsIncreaserCostSpan2 = document.getElementById('pcs-increaser-cost-2');
        const pcsCountSpan2 = document.getElementById('pcs-count-2');
        const pcsIncreaserCostSpan3 = document.getElementById('pcs-increaser-cost-3');
        const pcsCountSpan3 = document.getElementById('pcs-count-3');

        const buyButtons = document.querySelectorAll('.buy-button');
        
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsButton = document.getElementById('close-settings');
        const saveButton = document.getElementById('save-button');
        const restartButton = document.getElementById('restart-button');
        const saveStatus = document.getElementById('save-status');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmActionButton = document.getElementById('confirm-action');
        const cancelActionButton = document.getElementById('cancel-action');
        const confirmationText = document.getElementById('confirmation-text');
        
        const toggleAutoPurchaseButton = document.getElementById('toggle-auto-purchase');
        
        const rebirthButton1 = document.getElementById('buy-rebirth-1'); 
        const rebirthCostSpan1 = document.getElementById('rebirth-cost-1');
        
        const permUpgradesContainer = document.getElementById('perm-upgrades-container'); 

        let money = 0; 
        let basePcs = 0.0;
        let pcsMultiplier = 1; 
        let boostMultiplier = 1;
        let pcMultiplier = 1; 
        let rebirthCount = 0; 
        let pcs = 0.0;
        let clickValue = 1; 
        let basePps = 0; 
        let boostDurationSeconds = 30;
        
        let isAutoPurchaseEnabled = false;
        let autoPurchaseStep = 0; 

        let pcsIncreaserCount1 = 0; 
        let pcsIncreaserCost1 = 50;
        const INITIAL_COST_1 = 50;
        const COST_MULTIPLIER_1 = 1.1;
        const REWARD_ADD_1 = 1;

        let pcsIncreaserCount2 = 0; 
        let pcsIncreaserCost2 = 500;
        const INITIAL_COST_2 = 500;
        const COST_MULTIPLIER_2 = 1.15;
        const REWARD_ADD_2 = 10;

        let pcsIncreaserCount3 = 0; 
        let pcsIncreaserCost3 = 5000;
        const INITIAL_COST_3 = 5000;
        const COST_MULTIPLIER_3 = 1.2;
        const REWARD_ADD_3 = 100;
        
        let flappyBirdRewardPurchased = false; 

        const PERM_UPGRADES = {
            perm2xRewords: {
                cost: 15000,
                purchased: false,
                effect: () => pcsMultiplier *= 2,
                name: "Super Soap üßº",
                desc: "Permanent Double PCS",
                id: "buy-perm-2x-rewords"
            },
            autoClickMaster: {
                cost: 250000,
                purchased: false,
                effect: () => basePps += 1,
                name: "Auto-Click Master (+1 PPS)",
                desc: "Adds a passive +1 Pibbcoin per second to your income.",
                id: "buy-auto-click-master"
            },
            superBoostExtender: {
                cost: 750000,
                purchased: false,
                effect: () => boostDurationSeconds = 60,
                name: "ULTIMATE WASH MY BELLY MODE!",
                desc: "Increases 3x Golden Sponge Duration",
                id: "buy-boost-extender"
            }
        };

        
        const FLAPPY_REWARD_UPGRADE = {
            cost: 0, 
            purchased: false,
            effect: () => pcsMultiplier *= 1.1,
            name: "Flappy Bird Mastery üê¶",
            desc: "Permanent 1.1x PCS multiplier (Unlocked after Flappy Bird Score 15+)",
            id: "buy-flappy-pcs-multiplier"
        };


        
        const REBIRTH_CONFIG = {
            1: {
                cost: 20000000, 
                pcReward: 3, 
                name: "New Dawn",
                desc: "Resets all progress (except PC multiplier) for a 3x Permanent Click Multiplier.",
                id: "rebirth-1"
            }
        };

        let gameLoopInterval;
        let autoPurchaseInterval;
        let boostInterval;
        let boostTimeout;
        let spongeTimeout;
        let spongeInterval;
        

        function gameLoop() {
            money += pcs; 
            money += basePps * pcMultiplier; 
            updateDisplay(); 
        }

        function startGameLoop() {
            gameLoopInterval = setInterval(gameLoop, 1000); 
        }
        
        function getCost(tier) {
            if (tier === 1) return Math.ceil(pcsIncreaserCost1);
            if (tier === 2) return Math.ceil(pcsIncreaserCost2);
            if (tier === 3) return Math.ceil(pcsIncreaserCost3);
            return Infinity;
        }
        
        function handleAutoPurchase() {
    if (!isAutoPurchaseEnabled) return;

    
    const c1 = pcsIncreaserCount1; 
    const c2 = pcsIncreaserCount2; 
    const c3 = pcsIncreaserCount3; 

    let tierToBuy = null;
    
    
    const targetC2 = c1 - 10;
    
    
    const targetC3 = c1 - 20; 

    
    
    
    if (c3 < targetC3 && money >= getCost(3)) {
        tierToBuy = 3;
    } 
    
    
    
    else if (c2 < targetC2 && money >= getCost(2)) {
        tierToBuy = 2;
    } 
    
    
    
    else if (c2 === targetC2 && c3 === targetC3 && money >= getCost(1)) {
        tierToBuy = 1;
    } 
    
    
    if (tierToBuy) {
        buyPibbleWasher(tierToBuy);
        updateDisplay();
    }
    
}
        
        function startAutoPurchaseLoop() {
            if (!autoPurchaseInterval) {
                autoPurchaseInterval = setInterval(handleAutoPurchase, 100); 
            }
        }

        function stopAutoPurchaseLoop() {
            clearInterval(autoPurchaseInterval);
            autoPurchaseInterval = null;
        }

        function calculateReward(tier) {
            let count, reward;
            
            if (tier === 1) {
                count = pcsIncreaserCount1;
                reward = REWARD_ADD_1; 
            } else if (tier === 2) {
                count = pcsIncreaserCount2;
                reward = REWARD_ADD_2;
            } else if (tier === 3) {
                count = pcsIncreaserCount3;
                reward = REWARD_ADD_3;
            } else {
                return 0;
            }
            return count * reward;
        }

        function recalculateTotalPcs() {
            basePcs = calculateReward(1) + calculateReward(2) + calculateReward(3);
            
            let currentPcsMultiplier = pcsMultiplier;
            if (flappyBirdRewardPurchased) {
                currentPcsMultiplier *= 1.1; 
            }
            
            pcs = basePcs * boostMultiplier * currentPcsMultiplier * pcMultiplier;
        }

        const formatNumber = (num) => {
            const flooredNum = Math.floor(num); 
            if (flooredNum >= 1e9) return (flooredNum / 1e9).toFixed(2) + 'B';
            if (flooredNum >= 1e6) return (flooredNum / 1e6).toFixed(2) + 'M';
            if (flooredNum >= 1e3) return (flooredNum / 1e3).toFixed(2) + 'K';
            return flooredNum.toString();
        };
        
        const formatCost = (num) => {
            const cost = Math.ceil(num);
            if (cost >= 1e9) return (cost / 1e9).toFixed(2) + 'B';
            if (cost >= 1e6) return (cost / 1e6).toFixed(2) + 'M';
            if (cost >= 1e3) return (cost / 1e3).toFixed(2) + 'K';
            return cost.toString();
        };


        function updateDisplay() {
            const formattedMoney = formatNumber(money);
            moneyDisplay.textContent = formattedMoney; 
            moneyDisplayMobile.textContent = formattedMoney;
            
            
            const totalPcsWithPps = pcs + (basePps * pcMultiplier); 
            pcsDisplay.textContent = totalPcsWithPps.toFixed(1); 
            
            
            
            
            checkButtonStates();

            pcsCountSpan1.textContent = pcsIncreaserCount1;
            pcsCountSpan2.textContent = pcsIncreaserCount2;
            pcsCountSpan3.textContent = pcsIncreaserCount3;
        }
        
        function handleMainClick() {
            
            money += clickValue * boostMultiplier * pcMultiplier; 
            updateDisplay();
        }

        function checkButtonStates() {
            const cost1 = getCost(1);
            const cost2 = getCost(2);
            const cost3 = getCost(3);
            const rebirthCost = REBIRTH_CONFIG[1].cost;

            document.getElementById('buy-pcs-increaser-1').disabled = money < cost1;
            pcsIncreaserCostSpan1.textContent = `${formatCost(cost1)} Pibbcoins`;
            
            document.getElementById('buy-pcs-increaser-2').disabled = money < cost2;
            pcsIncreaserCostSpan2.textContent = `${formatCost(cost2)} Pibbcoins`;
            
            document.getElementById('buy-pcs-increaser-3').disabled = money < cost3;
            pcsIncreaserCostSpan3.textContent = `${formatCost(cost3)} Pibbcoins`;
            
            for (const key in PERM_UPGRADES) {
                const upgrade = PERM_UPGRADES[key];
                const button = document.getElementById(upgrade.id);
                if (button) {
                    button.disabled = upgrade.purchased || money < upgrade.cost;
                    const span = button.querySelector('span');
                    if (upgrade.purchased) {
                        button.textContent = 'Purchased';
                        button.disabled = true;
                        button.classList.remove('bg-amber-500', 'hover:bg-amber-400');
                        button.classList.add('bg-lime-500');
                    }
                }
            }
            
            const flappyButton = document.getElementById(FLAPPY_REWARD_UPGRADE.id);
            if (flappyButton) {
                flappyButton.disabled = FLAPPY_REWARD_UPGRADE.purchased || !flappyBirdRewardPurchased;
                if (FLAPPY_REWARD_UPGRADE.purchased) {
                    flappyButton.textContent = 'Purchased';
                    flappyButton.disabled = true;
                    flappyButton.classList.remove('bg-amber-500', 'hover:bg-amber-400');
                    flappyButton.classList.add('bg-lime-500');
                } else if (!flappyBirdRewardPurchased) {
                    flappyButton.querySelector('span').textContent = 'Win Flappy Bird (Score 15+)'
                } else {
                    flappyButton.querySelector('span').textContent = 'FREE! (1.1x PCS)'
                }
            }

            rebirthButton1.disabled = money < rebirthCost;
            rebirthCostSpan1.textContent = `${formatCost(rebirthCost)} Pibbcoins`;
        }

        function calculateNextCost(initialCost, count, multiplier) {
            return initialCost * Math.pow(multiplier, count);
        }

        function buyPibbleWasher(tier) {
            let currentCost;
            let currentCount;
            let initialCost;
            let costMultiplier;
            let rewardAdd; 

            if (tier === 1) {
                currentCost = pcsIncreaserCost1;
                currentCount = pcsIncreaserCount1;
                initialCost = INITIAL_COST_1;
                costMultiplier = COST_MULTIPLIER_1;
                rewardAdd = REWARD_ADD_1;
            } else if (tier === 2) {
                currentCost = pcsIncreaserCost2;
                currentCount = pcsIncreaserCount2;
                initialCost = INITIAL_COST_2;
                costMultiplier = COST_MULTIPLIER_2;
                rewardAdd = REWARD_ADD_2;
            } else if (tier === 3) {
                currentCost = pcsIncreaserCost3;
                currentCount = pcsIncreaserCount3;
                initialCost = INITIAL_COST_3;
                costMultiplier = COST_MULTIPLIER_3;
                rewardAdd = REWARD_ADD_3;
            } else {
                return;
            }

            if (money < currentCost) {
                return;
            }

            money -= currentCost;
            currentCount += 1;

            const nextCost = calculateNextCost(initialCost, currentCount, costMultiplier);

            if (tier === 1) {
                pcsIncreaserCount1 = currentCount;
                pcsIncreaserCost1 = nextCost;
            } else if (tier === 2) {
                pcsIncreaserCount2 = currentCount;
                pcsIncreaserCost2 = nextCost;
            } else if (tier === 3) {
                pcsIncreaserCount3 = currentCount;
                pcsIncreaserCost3 = nextCost;
            }
    
            recalculateTotalPcs(); 

            updateDisplay();
        }

        buyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tier = parseInt(button.getAttribute('data-tier'));
                buyPibbleWasher(tier);
        });
        });
        
        function buyPermUpgrade(upgradeKey) {
            const upgrade = PERM_UPGRADES[upgradeKey];
            if (upgrade && !upgrade.purchased && money >= upgrade.cost) {
                money -= upgrade.cost;
                upgrade.purchased = true;
                upgrade.effect();
                recalculateTotalPcs(); 
                updateDisplay();
                saveGame();
                renderPermUpgrades(); 
            }
        }
        
        function buyFlappyReward() {
             if (flappyBirdRewardPurchased && !FLAPPY_REWARD_UPGRADE.purchased) {
                 FLAPPY_REWARD_UPGRADE.purchased = true;
                 FLAPPY_REWARD_UPGRADE.effect();
                 recalculateTotalPcs();
                 updateDisplay();
                 saveGame();
                 renderPermUpgrades();
             }
        }
        
        function handleRebirth(tier) {
            const config = REBIRTH_CONFIG[tier];
            if (money >= config.cost) {
                showConfirmationModal(`Are you sure you want to perform the "${config.name}" Rebirth? You will reset most progress for a ${config.pcReward}x Permanent Click Multiplier!`, () => {
                    performRebirth(config);
                });
            }
        }

        function performRebirth(config) {
            pcMultiplier *= config.pcReward;
            rebirthCount++;
            
            money = 0;
            basePcs = 0;
            pcs = 0;
            pcsIncreaserCount1 = 0;
            pcsIncreaserCost1 = INITIAL_COST_1;
            pcsIncreaserCount2 = 0;
            pcsIncreaserCost2 = INITIAL_COST_2;
            pcsIncreaserCount3 = 0;
            pcsIncreaserCost3 = INITIAL_COST_3;
            isAutoPurchaseEnabled = false;
            toggleAutoPurchaseButton.textContent = 'OFF';
            stopAutoPurchaseLoop();
            
            boostMultiplier = 1;
            clearTimeout(boostTimeout);
            clearInterval(boostInterval);
            boostTimer.classList.add('hidden');
            
            for (const key in PERM_UPGRADES) {
                PERM_UPGRADES[key].purchased = false;
            }
            basePps = 0;
            pcsMultiplier = 1;

            recalculateTotalPcs();
            updateDisplay();
            saveGame();
            renderPermUpgrades();
            
            alert(`Rebirth successful! Permanent Click Multiplier is now ${pcMultiplier}x. Happy clicking!`);
        }
        
        function renderPermUpgrades() {
            permUpgradesContainer.innerHTML = ''; 
            
            if (flappyBirdRewardPurchased || FLAPPY_REWARD_UPGRADE.purchased) {
                 const upgrade = FLAPPY_REWARD_UPGRADE;
                 const item = document.createElement('div');
                 item.className = 'flex flex-col sm:flex-row justify-between items-center bg-blue-700/70 p-4 rounded-lg shadow-inner shadow-blue-900/50 transition duration-200 ' + (upgrade.purchased ? 'bg-lime-700/70' : 'hover:bg-blue-600/70');
                 item.innerHTML = `
                     <div class="mb-2 sm:mb-0 text-center sm:text-left">
                         <p class="text-xl font-bold">${upgrade.name}</p>
                         <p class="text-sm text-fuchsia-300 font-mono mt-0.5">${upgrade.desc}</p>
                     </div>
                     <button 
                         id="${upgrade.id}" 
                         class="buy-button w-full sm:w-auto px-6 py-2 rounded-xl font-bold text-blue-900 transition duration-150 shadow-lg disabled:opacity-30 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98] ${upgrade.purchased ? 'bg-lime-500' : 'bg-amber-500 hover:bg-amber-400'}"
                         data-perm-key="flappyBirdReward"
                         ${upgrade.purchased ? 'disabled' : ''}
                     >
                         <span>${upgrade.purchased ? 'Purchased' : (flappyBirdRewardPurchased ? 'FREE! (1.1x PCS)' : 'Win Flappy Bird (Score 15+)')}</span>
                     </button>
                 `;
                 permUpgradesContainer.appendChild(item);
                 
                 const button = document.getElementById(upgrade.id);
                 if (button && !upgrade.purchased) {
                      button.addEventListener('click', () => buyFlappyReward());
                 }
            }

            for (const key in PERM_UPGRADES) {
                const upgrade = PERM_UPGRADES[key];
                const item = document.createElement('div');
                item.className = 'flex flex-col sm:flex-row justify-between items-center bg-blue-700/70 p-4 rounded-lg shadow-inner shadow-blue-900/50 transition duration-200 ' + (upgrade.purchased ? 'bg-lime-700/70' : 'hover:bg-blue-600/70');
                item.innerHTML = `
                    <div class="mb-2 sm:mb-0 text-center sm:text-left">
                        <p class="text-xl font-bold">${upgrade.name}</p>
                        <p class="text-sm text-fuchsia-300 font-mono mt-0.5">${upgrade.desc}</p>
                    </div>
                    <button 
                        id="${upgrade.id}" 
                        class="buy-button w-full sm:w-auto px-6 py-2 rounded-xl font-bold text-blue-900 transition duration-150 shadow-lg disabled:opacity-30 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98] ${upgrade.purchased ? 'bg-lime-500' : 'bg-amber-500 hover:bg-amber-400'}"
                        data-perm-key="${key}"
                        ${upgrade.purchased ? 'disabled' : ''}
                    >
                        <span>${upgrade.purchased ? 'Purchased' : `${formatCost(upgrade.cost)} Pibbcoins`}</span>
                    </button>
                `;
                permUpgradesContainer.appendChild(item);
            }
            
            permUpgradesContainer.querySelectorAll('.buy-button').forEach(button => {
                const key = button.getAttribute('data-perm-key');
                if (key !== 'flappyBirdReward' && !PERM_UPGRADES[key].purchased) {
                    button.addEventListener('click', () => buyPermUpgrade(key));
                }
            });
            
            checkButtonStates();
        }


        function saveGame() {
            const saveObject = {
                money,
                pcsIncreaserCount1,
                pcsIncreaserCost1,
                pcsIncreaserCount2,
                pcsIncreaserCost2,
                pcsIncreaserCount3,
                pcsIncreaserCost3,
                pcMultiplier,
                rebirthCount,
                permUpgrades: {},
                basePps,
                pcsMultiplier: 1,
                isAutoPurchaseEnabled,
                flappyBirdRewardPurchased,
                flappyRewardPurchased: FLAPPY_REWARD_UPGRADE.purchased
            };
            
            for (const key in PERM_UPGRADES) {
                saveObject.permUpgrades[key] = {
                    purchased: PERM_UPGRADES[key].purchased
                };
            }
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saveObject));
        }

        function loadGame() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) {
                console.log('No saved game found.');
                return;
            }
            
            const saveObject = JSON.parse(savedData);
            
            money = saveObject.money || 0;
            pcsIncreaserCount1 = saveObject.pcsIncreaserCount1 || 0;
            pcsIncreaserCost1 = saveObject.pcsIncreaserCost1 || INITIAL_COST_1;
            pcsIncreaserCount2 = saveObject.pcsIncreaserCount2 || 0;
            pcsIncreaserCost2 = saveObject.pcsIncreaserCost2 || INITIAL_COST_2;
            pcsIncreaserCount3 = saveObject.pcsIncreaserCount3 || 0;
            pcsIncreaserCost3 = saveObject.pcsIncreaserCost3 || INITIAL_COST_3;
            pcMultiplier = saveObject.pcMultiplier || 1;
            rebirthCount = saveObject.rebirthCount || 0;
            basePps = saveObject.basePps || 0;
            isAutoPurchaseEnabled = saveObject.isAutoPurchaseEnabled || false;
            flappyBirdRewardPurchased = saveObject.flappyBirdRewardPurchased || false;
            FLAPPY_REWARD_UPGRADE.purchased = saveObject.flappyRewardPurchased || false;
            
            pcsMultiplier = 1;
            
            if (saveObject.permUpgrades) {
                for (const key in saveObject.permUpgrades) {
                    if (PERM_UPGRADES[key]) {
                        PERM_UPGRADES[key].purchased = saveObject.permUpgrades[key].purchased;
                        if (PERM_UPGRADES[key].purchased) {
                            PERM_UPGRADES[key].effect();
                        }
                    }
                }
            }

            if (FLAPPY_REWARD_UPGRADE.purchased) {
                 FLAPPY_REWARD_UPGRADE.effect();
            }
            
            toggleAutoPurchaseButton.textContent = isAutoPurchaseEnabled ? 'ON' : 'OFF';
            toggleAutoPurchaseButton.classList.remove('bg-red-600', 'bg-lime-500');
            toggleAutoPurchaseButton.classList.add(isAutoPurchaseEnabled ? 'bg-lime-500' : 'bg-red-600');
            if (isAutoPurchaseEnabled) {
                startAutoPurchaseLoop();
            }

            recalculateTotalPcs();
            updateDisplay();
            renderPermUpgrades();
            console.log('Game loaded successfully.');
        }

        function resetGame() {
            localStorage.removeItem(STORAGE_KEY);
            location.reload(); 
        }

        function startBoost() {
            if (boostMultiplier === 1) {
                boostMultiplier = 3;
                boostTimer.classList.remove('hidden');
                
                let remainingTime = boostDurationSeconds;
                
                boostCountdown.textContent = `${remainingTime.toFixed(1)}s`;
                
                recalculateTotalPcs();
                updateDisplay();

                clearInterval(boostInterval);
                boostInterval = setInterval(() => {
                    remainingTime -= 0.1;
                    boostCountdown.textContent = `${remainingTime.toFixed(1)}s`;
                    
                    if (remainingTime <= 0) {
                        endBoost();
                    }
                }, 100);
                
                clearTimeout(boostTimeout);
                boostTimeout = setTimeout(endBoost, boostDurationSeconds * 1000);
            }
        }

        function endBoost() {
            boostMultiplier = 1;
            boostTimer.classList.add('hidden');
            clearInterval(boostInterval);
            recalculateTotalPcs();
            updateDisplay();
        }

        function spawnGoldenSponge() {
            const sponge = document.createElement('img');
            sponge.src = GOLDEN_SPONGE_URL;
            sponge.className = 'golden-sponge fixed hidden';
            
            const top = Math.random() * 80 + 10;
            const left = Math.random() * 80 + 10;
            
            sponge.style.top = `${top}vh`;
            sponge.style.left = `${left}vw`;
            sponge.style.transform = `translate(-50%, -50%) scale(1)`;

            document.body.appendChild(sponge);
            
            setTimeout(() => {
                 sponge.classList.remove('hidden');
            }, 10);
            
            sponge.addEventListener('click', () => {
                startBoost();
                sponge.style.opacity = '0';
                sponge.style.transform = 'translate(-50%, -50%) scale(0.5)';
                setTimeout(() => sponge.remove(), 300);
                clearTimeout(spongeTimeout);
                scheduleNextSponge();
            });
            
            spongeTimeout = setTimeout(() => {
                sponge.style.opacity = '0';
                sponge.style.transform = 'translate(-50%, -50%) scale(0.5)';
                setTimeout(() => sponge.remove(), 300);
                scheduleNextSponge();
            }, 10000);
        }

        function scheduleNextSponge() {
            const randomDelay = (Math.random() * 60 + 60) * 1000; 
            spongeInterval = setTimeout(spawnGoldenSponge, randomDelay);
            console.log(`Next Golden Sponge scheduled in ${Math.round(randomDelay / 1000)} seconds.`);
        }
        
        function showConfirmationModal(text, onConfirm) {
            confirmationText.textContent = text;
            confirmationModal.classList.remove('hidden');

            const handleConfirm = () => {
                onConfirm();
                closeConfirmationModal();
            };

            confirmActionButton.onclick = handleConfirm;
            cancelActionButton.onclick = closeConfirmationModal;
        }

        function closeConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmActionButton.onclick = null;
            cancelActionButton.onclick = null;
        }

        function showSaveStatus(message, isError = false) {
            saveStatus.textContent = message;
            saveStatus.classList.remove('opacity-0', 'text-lime-400', 'text-red-400');
            saveStatus.classList.add('opacity-100', isError ? 'text-red-400' : 'text-lime-400');
            
            setTimeout(() => {
                saveStatus.classList.remove('opacity-100');
                saveStatus.classList.add('opacity-0');
            }, 3000);
        }
        
        function toggleFlappyBird() {
            flappyGame.classList.toggle('hidden');
        }
        
        clickerSquare.addEventListener('mousedown', () => {
            clickerSquare.classList.add('clicked');
            clickerSquare.src = CLICK_DOWN_IMAGE_SRC;
            handleMainClick();
        });
        
        clickerSquare.addEventListener('mouseup', () => {
            clickerSquare.classList.remove('clicked');
            clickerSquare.src = DEFAULT_IMAGE_SRC;
        });
        
        clickerSquare.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            clickerSquare.classList.add('clicked');
            clickerSquare.src = CLICK_DOWN_IMAGE_SRC;
            handleMainClick();
        }, { passive: false });
        
        clickerSquare.addEventListener('touchend', (e) => {
            e.preventDefault(); 
            clickerSquare.classList.remove('clicked');
            clickerSquare.src = DEFAULT_IMAGE_SRC;
        }, { passive: false });

        buyButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const tier = parseInt(e.currentTarget.getAttribute('data-tier'));
                buyPibbleWasher(tier);
            });
        });
        
        settingsButton.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
        });

        closeSettingsButton.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });
        
        saveButton.addEventListener('click', () => {
            saveGame();
            showSaveStatus('Game saved successfully!');
        });
        
        restartButton.addEventListener('click', () => {
            showConfirmationModal('Are you sure you want to restart all progress? This cannot be undone and you must click the Save button once before continuing to keep your progress.', () => {
                resetGame();
            });
        });
        
        toggleAutoPurchaseButton.addEventListener('click', () => {
            isAutoPurchaseEnabled = !isAutoPurchaseEnabled;
            toggleAutoPurchaseButton.textContent = isAutoPurchaseEnabled ? 'ON' : 'OFF';
            toggleAutoPurchaseButton.classList.remove('bg-red-600', 'bg-lime-500');
            toggleAutoPurchaseButton.classList.add(isAutoPurchaseEnabled ? 'bg-lime-500' : 'bg-red-600');

            if (isAutoPurchaseEnabled) {
                startAutoPurchaseLoop();
            } else {
                stopAutoPurchaseLoop();
            }
        });
        
        rebirthButton1.addEventListener('click', () => {
            handleRebirth(1);
        });
        
        flappyToggleButton.addEventListener('click', toggleFlappyBird);

        loadGame();
        startGameLoop();
        scheduleNextSponge(); 
        
        const canvas = document.getElementById('flappy-canvas');
        const ctx = canvas.getContext('2d');
        const WIDTH = canvas.width;
        const HEIGHT = canvas.height;

        let birdY = HEIGHT / 2;
        let birdVelocity = 0;
        const gravity = 0.5;
        const jumpStrength = -8;
        let score = 0;
        let isFlappyGameOver = true;
        let pipes = [];
        let pipeGap = 120;
        let pipeWidth = 20;
        let frameCount = 0;
        let gameSpeed = 2;
        const PIPE_INTERVAL = 100
        let flappyCoin = 0;

        function drawBird() {
            ctx.fillStyle = 'yellow';
            ctx.fillRect(50, birdY, 15, 15);
        }

        function drawPipe(pipe) {
            ctx.fillStyle = 'green';
            ctx.fillRect(pipe.x, 0, pipeWidth, pipe.top);
            ctx.fillRect(pipe.x, pipe.bottom, pipeWidth, HEIGHT - pipe.bottom);
        }

        function updateFlappyGame() {
            if (isFlappyGameOver) return;
            
            birdVelocity += gravity;
            birdY += birdVelocity;

            if (birdY > HEIGHT - 15 || birdY < 0) {
                gameOver();
                return;
            }

            if (frameCount % PIPE_INTERVAL === 0) {
                const minHeight = 40;
                const maxHeight = HEIGHT - pipeGap - minHeight;
                const topHeight = Math.floor(Math.random() * (maxHeight - minHeight)) + minHeight;
                pipes.push({
                    x: WIDTH,
                    top: topHeight,
                    bottom: topHeight + pipeGap,
                    passed: false
                });
            }

            for (let i = 0; i < pipes.length; i++) {
                const pipe = pipes[i];
                pipe.x -= gameSpeed;
                
                if (50 < pipe.x + pipeWidth && 65 > pipe.x) {
                    if (birdY < pipe.top || birdY + 15 > pipe.bottom) {
                        gameOver();
                        return;
                    }
                }
                
                if (pipe.x + pipeWidth < 50 && !pipe.passed) {
                    score++;
                    pipe.passed = true;
                    if (score > 0 && score % 10 === 0) {
                         gameSpeed += 0.2;
                    }
                }
            }

            pipes = pipes.filter(pipe => pipe.x > -pipeWidth);
            frameCount++;
        }

        function renderFlappyGame() {
            ctx.clearRect(0, 0, WIDTH, HEIGHT); 
            pipes.forEach(drawPipe);
            drawBird();

            ctx.fillStyle = 'black';
            ctx.font = '20px Arial';
            ctx.fillText(`Score: ${score}`, 10, 25);
            
            if (isFlappyGameOver) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, WIDTH, HEIGHT);
                ctx.fillStyle = 'white';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('FLAPPY PIBBLE!', WIDTH / 2, HEIGHT / 2 - 40);
                ctx.font = '16px Arial';
                ctx.fillText(`Final Score: ${score}`, WIDTH / 2, HEIGHT / 2);
                ctx.fillText('Click to Start/Flap', WIDTH / 2, HEIGHT / 2 + 30);
                ctx.textAlign = 'left';

                if (score >= 15 && !flappyBirdRewardPurchased) {
                    flappyBirdRewardPurchased = true;
                    saveGame();
                    renderPermUpgrades();
                    flappyCoin = 1
                }
            }
        }

        let flappyGameLoop;
        function flappyLoop() {
            updateFlappyGame();
            renderFlappyGame();
            flappyGameLoop = requestAnimationFrame(flappyLoop);
        }

        function flappyJump() {
            if (isFlappyGameOver) {
                isFlappyGameOver = false;
                birdY = HEIGHT / 2;
                birdVelocity = 0;
                score = 0;
                pipes = [];
                frameCount = 0;
                gameSpeed = 2; 
                birdVelocity = jumpStrength; 
                if (!flappyGameLoop) {
                    flappyLoop();
                }
            } else {
                birdVelocity = jumpStrength;
            }
        }

        function gameOver() {
            isFlappyGameOver = true;
            renderFlappyGame();
        }

        canvas.addEventListener('click', flappyJump);
        window.addEventListener('keydown', (e) => {
             if (e.code === 'Space' && !flappyGame.classList.contains('hidden')) {
                e.preventDefault();
                flappyJump();
            }
        });
        
        flappyLoop();
        
        document.addEventListener("keydown", function (e) {
            if (e.key === "F9") {
                window.open("https://fed.education.qld.gov.au/idp/SSO.saml2?SAMLRequest=fVJbT8IwFH73Vyx9XzfGuDVsCUKMJKiETR98Md12Bk26dvSC%2Bu%2FthkZ8kNev3%2B2c07mmDW%2FJwpqD2MHRgjbeR8OFJv1DgqwSRFLNNBG0AU1MSbLFw4ZEOCStkkaWkqMLyXUF1RqUYVIgb71K0FtRw5CO48IfwSDy43oy8Wcwjf0QJvEgHNfTcTFG3gso7TQJchZOqLWFtdCGCuOgMBr5ThuO8mhI4hGJZq%2FIW7k5mKCmVx2MaTUJghoqDJUtexgfeYX38oSpDVjVBln2hLv%2BEfIWPyWXUmjbgMpAnVgJz7vNr9mRA1UCw7Gz7Ey43DMRdBbI234v5paJion99Z0UZ5Im93m%2B9bdPWY7SeedD%2BklV2kV2ia4%2Bc2MrWxqrAJey6eOieXDJnp8v%2Buhy1qut5Kz89O6kaqj5v8YAD3qEVX7dU4kVuoWS1QwqtxDO5ftSATWQIJcPKEjPoX9%2FTnrzBQ%3D%3D", "_blank");
            }
        });

    </script>
</body>
</html>
