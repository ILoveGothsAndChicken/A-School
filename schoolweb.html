<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pibble Clicker!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background-color: #010619;
            background-image: radial-gradient(at 50% 10%, #1e3a8a, #0b1a3d, #030712);
            position: relative;
            font-family: 'Inter', sans-serif;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(2px 2px at 20px 30px, #fff, rgba(255, 255, 255, 0)),
                radial-gradient(2px 2px at 80px 100px, #fff, rgba(255, 255, 255, 0)),
                radial-gradient(3px 3px at 150px 150px, #fff, rgba(255, 255, 255, 0)),
                radial-gradient(2px 2px at 200px 70px, #fff, rgba(255, 255, 255, 0)),
                radial-gradient(1px 1px at 300px 200px, #fff, rgba(255, 255, 255, 0));
            background-size: 300px 300px;
            opacity: 0.6;
            animation: twinkle 15s infinite alternate;
            pointer-events: none;
            z-index: 1; 
        }

        @keyframes twinkle {
            0% { opacity: 0.6; }
            100% { opacity: 0.8; }
        }

        #clicker-square {
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
            cursor: pointer;
            user-select: none;
            will-change: transform;
            object-fit: contain;
            position: relative; 
            z-index: 30; 
            filter: drop-shadow(0 0 20px rgba(100, 149, 237, 0.7));
        }

        .clicked {
            transform: scale(0.9) rotate(-10deg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        }

        @keyframes strong-wind-left {
            0% { transform: translateX(0) scaleX(1); opacity: 0.8; }
            100% { transform: translateX(30%) scaleX(0.05); opacity: 0; }
        }
        @keyframes strong-wind-right {
            0% { transform: translateX(0) scaleX(1); opacity: 0.8; }
            100% { transform: translateX(-30%) scaleX(0.05); opacity: 0; }
        }

        .wind-line {
            position: absolute;
            width: 120px; 
            height: 4px;
            background: rgba(173, 216, 230, 0.8);
            border-radius: 2px;
            pointer-events: none;
            z-index: 20; 
        }
        .wind-line.left { animation: strong-wind-left 0.7s infinite linear; transform-origin: left center; }
        #line-1 { top: 15%; left: -30%; animation-delay: 0s; }
        #line-2 { top: 45%; left: -20%; animation-delay: 0.2s; width: 100px; }
        #line-3 { top: 75%; left: -35%; animation-delay: 0.4s; width: 140px; }
        .wind-line.right { animation: strong-wind-right 0.7s infinite linear; transform-origin: right center; }
        #line-4 { top: 15%; right: -30%; animation-delay: 0.1s; }
        #line-5 { top: 45%; right: -20%; animation-delay: 0.3s; width: 100px; }
        #line-6 { top: 75%; right: -35%; animation-delay: 0.5s; width: 140px; }

        .golden-sponge {
            position: fixed; 
            width: 70px;
            height: 70px;
            cursor: pointer;
            transition: opacity 0.3s, transform 0.1s;
            z-index: 100; 
            filter: drop-shadow(0 0 20px rgba(255, 223, 0, 1)) saturate(1.8);
        }
        .golden-sponge:active {
            transform: scale(0.85) !important;
        }

        #boost-timer {
            background: linear-gradient(135deg, #ffdd57 0%, #ff4500 100%);
            color: #0b1a3d;
            border: 3px solid #ffd700;
            box-shadow: 0 0 25px rgba(255, 215, 0, 1);
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            animation: pulse-boost 1s infinite alternate;
        }

        @keyframes pulse-boost {
            from { transform: scale(1); box-shadow: 0 0 25px rgba(255, 215, 0, 1); }
            to { transform: scale(1.05); box-shadow: 0 0 35px rgba(255, 215, 0, 1.2); }
        }
        
        #store-section {
            background: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(5px);
            border: 2px solid #1f3d8a;
            max-width: 600px;
            margin: 3rem auto 2rem auto;
        }
        
        @media (min-width: 1024px) {
            #store-section {
                max-width: 800px;
            }
        }
        
        .modal {
            background: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            background: #0b1a3d;
            border: 3px solid #1e3a8a;
            box-shadow: 0 0 30px rgba(30, 58, 138, 0.7);
            animation: slide-down 0.3s ease-out;
        }
        @keyframes slide-down {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="text-white flex flex-col items-center min-h-screen p-4 z-10 relative">

    <div id="boost-timer" class="fixed top-4 left-4 p-3 rounded-xl shadow-lg font-extrabold hidden z-50">
        <p class="text-lg">3X BOOST ACTIVE</p>
        <p class="text-3xl font-mono text-center" id="boost-countdown">30.0s</p>
    </div>
    
    <div class="w-full max-w-7xl flex flex-col items-center z-20">

        <header class="w-full flex justify-center items-start pt-6 pb-8 relative">
            
            <div id="money-box" class="absolute left-0 top-6 ml-4 hidden sm:block">
                <p class="text-xl font-medium text-blue-300">PibbCoins:</p>
                <p id="money-display" class="text-5xl font-mono text-lime-400 text-shadow-lg">
                    0
                </p>
            </div>

            <div class="flex flex-col items-center text-center pointer-events-none">
                <div class="flex justify-center items-center">
                    <div class="w-10 h-10 bg-amber-500 rounded-lg shadow-xl flex items-center justify-center p-1 pointer-events-auto border-2 border-amber-300 mr-2">
                        <img
                            src="https://raw.githubusercontent.com/ILoveGothsAndChicken/A-School/main/Pibble%20coin.png"
                            alt="Pibble Coin Icon"
                            class="w-full h-full object-contain"
                        />
                    </div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-blue-300 sm:text-4xl pointer-events-auto">
                        The Pibble Clicker
                    </h1>
                </div>
                
                <div id="pcs-box" class="flex items-baseline space-x-2 mt-4 pointer-events-auto">
                    <p class="text-2xl font-bold text-fuchsia-300">PPS:</p>
                    <p id="pcs-display" class="text-3xl font-mono text-fuchsia-400">
                        0.0
                    </p>
                </div>
            </div>

            <div class="absolute right-0 top-6 mr-4 flex flex-col items-end">
                <button id="settings-button" class="p-2 rounded-full bg-blue-700 hover:bg-blue-600 transition duration-150 z-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.493 3.518c-.856-1.026-2.522-1.026-3.377 0C7.26 4.606 6.51 6.136 5.59 7.37c-.783 1.047-2.31 1.047-3.093 0-.92-.816-1.527-1.847-1.745-3.016.086-1.127.848-1.996 2.012-2.17.653-.13 1.32-.178 2.016-.013 1.037.247 1.83.693 2.51 1.41a3.03 3.03 0 014.288 0c.68-.717 1.473-1.163 2.51-1.41 1.037-.247 1.776.083 2.012 1.178.218 1.169-.485 2.199-1.268 3.016-.92 1.234-1.67 2.764-2.59 3.998-.783 1.047-2.31 1.047-3.093 0-.92-1.234-1.67-2.764-2.59-3.998-.783 1.047-2.31 1.047-3.093 0-1.037 1.383-1.547 2.87-1.765 4.417.086 1.544.848 2.73 2.012 3.125.653.27 1.32.404 2.016.33 1.037-.184 1.83-.55 2.51-1.08a3.03 3.03 0 014.288 0c.68.53 1.473.896 2.51 1.08 1.037.183 1.776-.002 2.012-1.125.218-1.547-.485-3.034-1.268-4.417-1.037-1.67-1.747-3.32-2.34-4.83zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div class="sm:hidden mt-2">
                    <p class="text-base font-medium text-blue-300">PibbCoins:</p>
                    <p id="money-display-mobile" class="text-2xl font-mono text-lime-400">
                        0
                    </p>
                </div>
            </div>
            
        </header>

        <main class="w-full flex flex-col items-center">
            <div id="clicker-view" class="flex justify-center items-center relative my-12 w-full max-w-lg">
                <img
                    id="clicker-square"
                    class="w-48 h-48 sm:w-64 sm:h-64 rounded-xl shadow-2xl border-4 border-blue-300 bg-gray-700 p-2 relative"
                    role="button"
                    aria-label="Click to earn money"
                    src="https://raw.githubusercontent.com/ILoveGothsAndChicken/A-School/main/Perfect.png"
                    alt="Clickable Item"
                />
                <div id="line-1" class="wind-line left"></div>
                <div id="line-2" class="wind-line left"></div>
                <div id="line-3" class="wind-line left"></div>
                <div id="line-4" class="wind-line right"></div>
                <div id="line-5" class="wind-line right"></div>
                <div id="line-6" class="wind-line right"></div>
            </div>
        </main>

        <div id="store-section" class="w-full p-6 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold text-blue-300 mb-6 text-center border-b pb-3 border-blue-600">Store & Upgrades</h2>
            
            <div id="store-content-container" class="space-y-6">

                <div id="pcs-increaser-item-1" class="flex flex-col sm:flex-row justify-between items-center bg-blue-700/70 p-4 rounded-lg shadow-inner shadow-blue-900/50 hover:bg-blue-600/70 transition duration-200">
                    <div class="mb-2 sm:mb-0 text-center sm:text-left">
                        <p class="text-xl font-bold">Pibble Washer I (1x PCS)</p>
                        <p class="text-sm text-fuchsia-300 font-mono mt-0.5"><span id="pcs-count-1">0</span> owned</p>
                    </div>
                    <button 
                        id="buy-pcs-increaser-1" 
                        class="buy-button w-full sm:w-auto px-6 py-2 bg-amber-500 hover:bg-amber-400 rounded-xl font-bold text-blue-900 transition duration-150 shadow-lg disabled:opacity-30 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
                        data-tier="1"
                    >
                        <span id="pcs-increaser-cost-1">50 Pibbcoins</span>
                    </button>
                </div>

                <div id="pcs-increaser-item-2" class="flex flex-col sm:flex-row justify-between items-center bg-blue-700/70 p-4 rounded-lg shadow-inner shadow-blue-900/50 hover:bg-blue-600/70 transition duration-200">
                    <div class="mb-2 sm:mb-0 text-center sm:text-left">
                        <p class="text-xl font-bold">Pibble Washer II (10x PCS)</p>
                        <p class="text-sm text-fuchsia-300 font-mono mt-0.5"><span id="pcs-count-2">0</span> owned</p>
                    </div>
                    <button 
                        id="buy-pcs-increaser-2" 
                        class="buy-button w-full sm:w-auto px-6 py-2 bg-amber-500 hover:bg-amber-400 rounded-xl font-bold text-blue-900 transition duration-150 shadow-lg disabled:opacity-30 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
                        data-tier="2"
                    >
                        <span id="pcs-increaser-cost-2">500 Pibbcoins</span>
                    </button>
                </div>

                <div id="pcs-increaser-item-3" class="flex flex-col sm:flex-row justify-between items-center bg-blue-700/70 p-4 rounded-lg shadow-inner shadow-blue-900/50 hover:bg-blue-600/70 transition duration-200">
                    <div class="mb-2 sm:mb-0 text-center sm:text-left">
                        <p class="text-xl font-bold">Pibble Washer III (100x PCS)</p>
                        <p class="text-sm text-fuchsia-300 font-mono mt-0.5"><span id="pcs-count-3">0</span> owned</p>
                    </div>
                    <button 
                        id="buy-pcs-increaser-3" 
                        class="buy-button w-full sm:w-auto px-6 py-2 bg-amber-500 hover:bg-amber-400 rounded-xl font-bold text-blue-900 transition duration-150 shadow-lg disabled:opacity-30 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
                        data-tier="3"
                    >
                        <span id="pcs-increaser-cost-3">5,000 Pibbcoins</span>
                    </button>
                </div>

                <div class="bg-blue-900/60 p-4 rounded-lg shadow-md mt-6">
                    <p class="text-lg font-bold text-center text-gray-300">Passive Upgrades Coming Soon</p>
                    <p class="text-sm text-gray-400 text-center">These will boost your click value or PCS multipliers!</p>
                </div>

            </div>
            
        </div>
        
    </div>
    
    <div id="settings-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content w-full max-w-sm p-6 rounded-xl">
            <h2 class="text-3xl font-bold text-blue-300 mb-6 text-center border-b pb-3 border-blue-600">Settings</h2>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center py-3 px-2 border-y border-gray-700">
                    <p class="text-xl font-medium text-gray-200">Auto Purchase</p>
                    <button id="toggle-auto-purchase" class="px-4 py-2 rounded-xl font-bold text-white transition duration-150 shadow-md">
                        OFF
                    </button>
                </div>
                <button id="save-button" class="w-full px-6 py-3 bg-lime-500 hover:bg-lime-400 rounded-xl font-bold text-blue-900 transition duration-150 shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                    ðŸ’¾ Save
                </button>
                <button id="restart-button" class="w-full px-6 py-3 bg-red-600 hover:bg-red-500 rounded-xl font-bold text-white transition duration-150 shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                    ðŸ”„ Restart Progress
                </button>
                <button id="close-settings" class="w-full px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded-xl font-bold text-white transition duration-150 mt-4">
                    Close
                </button>
                <p id="save-status" class="text-center text-sm text-lime-400 mt-2 opacity-0 transition duration-300"></p>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content w-full max-w-xs p-6 rounded-xl">
            <p id="confirmation-text" class="text-xl font-bold text-gray-200 mb-6 text-center">Are you sure you want to restart? All unsaved progress will be lost.</p>
            <div class="flex justify-between space-x-4">
                <button id="confirm-action" class="w-1/2 px-4 py-2 bg-red-600 hover:bg-red-500 rounded-xl font-bold text-white transition duration-150 shadow-lg">Yes, Restart</button>
                <button id="cancel-action" class="w-1/2 px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-xl font-bold text-white transition duration-150">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_IMAGE_SRC = "https://raw.githubusercontent.com/ILoveGothsAndChicken/A-School/main/Perfect.png";
        const CLICK_DOWN_IMAGE_SRC = "https://github.com/ILoveGothsAndChicken/A-School/raw/main/Sponge%20Pibble.png";
        const GOLDEN_SPONGE_URL = 'https://github.com/ILoveGothsAndChicken/A-School/raw/main/Golden%20sponge.png';
        const STORAGE_KEY = 'pibbleClickerSave';
        
        const moneyDisplay = document.getElementById('money-display');
        const moneyDisplayMobile = document.getElementById('money-display-mobile');
        const pcsDisplay = document.getElementById('pcs-display'); 
        const clickerSquare = document.getElementById('clicker-square');
        const boostTimer = document.getElementById('boost-timer');
        const boostCountdown = document.getElementById('boost-countdown');

        const pcsIncreaserCostSpan1 = document.getElementById('pcs-increaser-cost-1');
        const pcsCountSpan1 = document.getElementById('pcs-count-1');
        const pcsIncreaserCostSpan2 = document.getElementById('pcs-increaser-cost-2');
        const pcsCountSpan2 = document.getElementById('pcs-count-2');
        const pcsIncreaserCostSpan3 = document.getElementById('pcs-increaser-cost-3');
        const pcsCountSpan3 = document.getElementById('pcs-count-3');

        const buyButtons = document.querySelectorAll('.buy-button');
        
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsButton = document.getElementById('close-settings');
        const saveButton = document.getElementById('save-button');
        const restartButton = document.getElementById('restart-button');
        const saveStatus = document.getElementById('save-status');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmActionButton = document.getElementById('confirm-action');
        const cancelActionButton = document.getElementById('cancel-action');
        const confirmationText = document.getElementById('confirmation-text');
        
        const toggleAutoPurchaseButton = document.getElementById('toggle-auto-purchase');


        let money = 0; 
        let basePcs = 0.0;
        let pcsMultiplier = 1;
        let boostMultiplier = 1;
        let pcs = 0.0;
        let clickValue = 1; 
        let basePps = 0; 
        let boostDurationSeconds = 30;
        
        let isAutoPurchaseEnabled = false;
        let autoPurchaseStep = 0; 

        let pcsIncreaserCount1 = 0; 
        let pcsIncreaserCost1 = 50;
        const INITIAL_COST_1 = 50;
        const COST_MULTIPLIER_1 = 1.1;
        const REWARD_ADD_1 = 1;

        let pcsIncreaserCount2 = 0; 
        let pcsIncreaserCost2 = 500;
        const INITIAL_COST_2 = 500;
        const COST_MULTIPLIER_2 = 1.15;
        const REWARD_ADD_2 = 10;

        let pcsIncreaserCount3 = 0; 
        let pcsIncreaserCost3 = 5000;
        const INITIAL_COST_3 = 5000;
        const COST_MULTIPLIER_3 = 1.2;
        const REWARD_ADD_3 = 100;
        
        const PERM_UPGRADES = {
            perm2xRewords: {
                cost: 15000,
                purchased: false,
                effect: () => pcsMultiplier *= 2,
                name: "Super Soap ðŸ§¼",
                desc: "Permanent Double PCS",
                id: "buy-perm-2x-rewords"
            },
            autoClickMaster: {
                cost: 250000,
                purchased: false,
                effect: () => basePps += 1,
                name: "Auto-Click Master (+1 PPS)",
                desc: "Adds a passive +1 Pibbcoin per second to your income.",
                id: "buy-auto-click-master"
            },
            superBoostExtender: {
                cost: 750000,
                purchased: false,
                effect: () => boostDurationSeconds = 60,
                name: "ULTIMATE WASH MY BELLY MODE!",
                desc: "Increases 3x Golden Sponge Duration",
                id: "buy-boost-extender"
            }
        };


        let gameLoopInterval;
        let autoPurchaseInterval;
        let boostInterval;
        let boostTimeout;
        let spongeTimeout;
        let spongeInterval;

        function gameLoop() {
            money += pcs; 
            money += basePps; 
            updateDisplay(); 
        }

        function startGameLoop() {
            gameLoopInterval = setInterval(gameLoop, 1000); 
        }
        
        function getCost(tier) {
            if (tier === 1) return Math.ceil(pcsIncreaserCost1);
            if (tier === 2) return Math.ceil(pcsIncreaserCost2);
            if (tier === 3) return Math.ceil(pcsIncreaserCost3);
            return Infinity;
        }
        
        function handleAutoPurchase() {
            if (!isAutoPurchaseEnabled) return;
            
            const cycleLength = 8;
            const currentStepInCycle = autoPurchaseStep % cycleLength; 
            let tierToBuy = -1;

            if (currentStepInCycle < 5) {
                tierToBuy = 1;
            } else if (currentStepInCycle < 7) {
                tierToBuy = 2;
            } else {
                tierToBuy = 3;
            }
            
            const cost = getCost(tierToBuy);
            
            if (money >= cost) {
                buyPibbleWasher(tierToBuy);
                
                autoPurchaseStep++;
                
                updateDisplay();
            }
        }
        
        function startAutoPurchaseLoop() {
            if (!autoPurchaseInterval) {
                autoPurchaseInterval = setInterval(handleAutoPurchase, 100); 
            }
        }

        function stopAutoPurchaseLoop() {
            clearInterval(autoPurchaseInterval);
            autoPurchaseInterval = null;
        }

        function calculateReward(tier) {
            let count, reward;
            
            if (tier === 1) {
                count = pcsIncreaserCount1;
                reward = REWARD_ADD_1; 
            } else if (tier === 2) {
                count = pcsIncreaserCount2;
                reward = REWARD_ADD_2;
            } else if (tier === 3) {
                count = pcsIncreaserCount3;
                reward = REWARD_ADD_3;
            } else {
                return 0;
            }
            return count * reward;
        }

        function recalculateTotalPcs() {
            basePcs = calculateReward(1) + calculateReward(2) + calculateReward(3);
            pcs = basePcs * boostMultiplier * pcsMultiplier;
        }

        const formatNumber = (num) => {
            const flooredNum = Math.floor(num); 
            if (flooredNum >= 1e9) return (flooredNum / 1e9).toFixed(2) + 'B';
            if (flooredNum >= 1e6) return (flooredNum / 1e6).toFixed(2) + 'M';
            if (flooredNum >= 1e3) return (flooredNum / 1e3).toFixed(2) + 'K';
            return flooredNum.toString();
        };
        
        const formatCost = (num) => {
            const cost = Math.ceil(num);
            if (cost >= 1e9) return (cost / 1e9).toFixed(2) + 'B';
            if (cost >= 1e6) return (cost / 1e6).toFixed(2) + 'M';
            if (cost >= 1e3) return (cost / 1e3).toFixed(2) + 'K';
            return cost.toString();
        };


        function updateDisplay() {
            const formattedMoney = formatNumber(money);
            moneyDisplay.textContent = formattedMoney; 
            moneyDisplayMobile.textContent = formattedMoney;
            
            pcsDisplay.textContent = (pcs + basePps).toFixed(1); 
            checkButtonStates();

            pcsCountSpan1.textContent = pcsIncreaserCount1;
            pcsCountSpan2.textContent = pcsIncreaserCount2;
            pcsCountSpan3.textContent = pcsIncreaserCount3;
        }
        
        function handleMainClick() {
            money += clickValue * boostMultiplier;
            updateDisplay();
        }

        function checkButtonStates() {
            const cost1 = getCost(1);
            const cost2 = getCost(2);
            const cost3 = getCost(3);

            document.getElementById('buy-pcs-increaser-1').disabled = money < cost1;
            pcsIncreaserCostSpan1.textContent = `${formatCost(cost1)} Pibbcoins`;
            
            document.getElementById('buy-pcs-increaser-2').disabled = money < cost2;
            pcsIncreaserCostSpan2.textContent = `${formatCost(cost2)} Pibbcoins`;
            
            document.getElementById('buy-pcs-increaser-3').disabled = money < cost3;
            pcsIncreaserCostSpan3.textContent = `${formatCost(cost3)} Pibbcoins`;
            
            for (const key in PERM_UPGRADES) {
                const upgrade = PERM_UPGRADES[key];
                const button = document.getElementById(upgrade.id);
                if (button) {
                    button.disabled = upgrade.purchased || money < upgrade.cost;
                    const span = button.querySelector('span');
                    if (span) {
                        span.textContent = upgrade.purchased ? 'PURCHASED' : `${formatCost(upgrade.cost)} Pibbcoins`;
                    }
                    
                    if (upgrade.purchased) {
                         button.classList.remove('bg-amber-500', 'hover:bg-amber-400', 'text-blue-900');
                         button.classList.add('bg-lime-700', 'text-white', 'cursor-default');
                    } else {
                         button.classList.add('bg-amber-500', 'hover:bg-amber-400', 'text-blue-900');
                         button.classList.remove('bg-lime-700', 'text-white', 'cursor-default');
                    }
                }
            }
        }

        function buyPibbleWasher(tier) {
            let currentCost, costMultiplier;

            if (tier === 1) {
                currentCost = pcsIncreaserCost1;
                costMultiplier = COST_MULTIPLIER_1;
            } else if (tier === 2) {
                currentCost = pcsIncreaserCost2;
                costMultiplier = COST_MULTIPLIER_2;
            } else if (tier === 3) {
                currentCost = pcsIncreaserCost3;
                costMultiplier = COST_MULTIPLIER_3;
            } else {
                return;
            }

            const costToPay = Math.ceil(currentCost);

            if (money >= costToPay) {
                money -= costToPay;
                
                if (tier === 1) {
                    pcsIncreaserCount1++;
                    pcsIncreaserCost1 *= costMultiplier;
                } else if (tier === 2) {
                    pcsIncreaserCount2++;
                    pcsIncreaserCost2 *= costMultiplier;
                } else if (tier === 3) {
                    pcsIncreaserCount3++;
                    pcsIncreaserCost3 *= costMultiplier;
                }

                recalculateTotalPcs();
            } 
        }
        
        function buyPermanentUpgrade(key) {
            const upgrade = PERM_UPGRADES[key];
            if (money >= upgrade.cost && !upgrade.purchased) {
                money -= upgrade.cost;
                upgrade.purchased = true;
                
                applyAllPermanentEffects(); 
                
                recalculateTotalPcs(); 
                updateDisplay();
            }
        }
        
        function applyAllPermanentEffects() {
            clickValue = 1;
            basePps = 0;
            boostDurationSeconds = 30;
            pcsMultiplier = 1;
            
            for (const key in PERM_UPGRADES) {
                if (PERM_UPGRADES[key].purchased) {
                    PERM_UPGRADES[key].effect();
                }
            }
        }

        const removeGoldenSponge = () => {
            const existingSponge = document.getElementById('golden-sponge');
            if (existingSponge) {
                existingSponge.remove();
            }
        };
        
        const activateBoost = () => {
            clearTimeout(boostTimeout);
            clearInterval(boostInterval);
            
            boostMultiplier = 3;
            recalculateTotalPcs();
            
            boostTimer.classList.remove('hidden');
            
            const boostDuration = boostDurationSeconds * 1000; 
            const boostEndTime = Date.now() + boostDuration;

            const updateCountdown = () => {
                const timeLeft = boostEndTime - Date.now();
                if (timeLeft <= 0) {
                    clearInterval(boostInterval);
                    boostMultiplier = 1;
                    recalculateTotalPcs();
                    boostTimer.classList.add('hidden');
                } else {
                    boostCountdown.textContent = (timeLeft / 1000).toFixed(1) + 's';
                }
            };
            
            updateCountdown();
            boostInterval = setInterval(updateCountdown, 100); 

            boostTimeout = setTimeout(() => {
                clearInterval(boostInterval);
                boostMultiplier = 1;
                recalculateTotalPcs();
                boostTimer.classList.add('hidden');
            }, boostDuration);
        };


        const spawnGoldenSponge = () => {
            removeGoldenSponge();
            clearInterval(spongeInterval);

            const sponge = document.createElement('img');
            sponge.id = 'golden-sponge';
            sponge.src = GOLDEN_SPONGE_URL;
            sponge.className = 'golden-sponge';
            
            const bodyRect = document.body.getBoundingClientRect();
            const spongeSize = 70; 
            
            const minX = 20;
            const minY = 100;
            const maxX = bodyRect.width - spongeSize - 20;
            const maxY = bodyRect.height - spongeSize - 20;
            
            const randomX = Math.random() * (maxX - minX) + minX;
            const randomY = Math.random() * (maxY - minY) + minY;
            const randomRotation = Math.random() * 360;
            
            sponge.style.left = `${randomX}px`;
            sponge.style.top = `${randomY}px`;
            sponge.style.transform = `rotate(${randomRotation}deg)`;
            
            document.body.appendChild(sponge);

            sponge.addEventListener('click', () => {
                removeGoldenSponge();
                activateBoost();
                scheduleNextSpawn(); 
            });
            
            const despawnTimeout = setTimeout(() => {
                if(document.getElementById('golden-sponge')) {
                    removeGoldenSponge();
                    scheduleNextSpawn();
                }
            }, 30000);
            
            sponge.addEventListener('click', () => {
                clearTimeout(despawnTimeout); 
            });
        };

        const scheduleNextSpawn = () => {
            clearTimeout(spongeTimeout);
            clearInterval(spongeInterval);
            
            const minTime = 240000; 
            const maxTime = 360000; 
            
            const delay = Math.floor(Math.random() * (maxTime - minTime + 1)) + minTime;
            const endTime = Date.now() + delay;
            spongeTimeout = setTimeout(spawnGoldenSponge, delay);
        };
        
        function saveGame() {
            const permanentUpgradesState = {};
            for (const key in PERM_UPGRADES) {
                permanentUpgradesState[key] = PERM_UPGRADES[key].purchased;
            }
            
            const gameState = {
                money: money,
                pcsIncreaserCount1: pcsIncreaserCount1,
                pcsIncreaserCost1: pcsIncreaserCost1,
                pcsIncreaserCount2: pcsIncreaserCount2,
                pcsIncreaserCost2: pcsIncreaserCost2,
                pcsIncreaserCount3: pcsIncreaserCount3,
                pcsIncreaserCost3: pcsIncreaserCost3,
                permUpgrades: permanentUpgradesState,
                isAutoPurchaseEnabled: isAutoPurchaseEnabled,
            };

            localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
            
            saveStatus.textContent = 'Game Saved!';
            saveStatus.classList.remove('opacity-0');
            setTimeout(() => {
                saveStatus.classList.add('opacity-0');
            }, 2000);
        }

        function loadGame() {
            const savedState = localStorage.getItem(STORAGE_KEY);
            if (savedState) {
                const gameState = JSON.parse(savedState);
                money = gameState.money || 0;
                pcsIncreaserCount1 = gameState.pcsIncreaserCount1 || 0;
                pcsIncreaserCost1 = gameState.pcsIncreaserCost1 || INITIAL_COST_1;
                pcsIncreaserCount2 = gameState.pcsIncreaserCount2 || 0;
                pcsIncreaserCost2 = gameState.pcsIncreaserCost2 || INITIAL_COST_2;
                pcsIncreaserCount3 = gameState.pcsIncreaserCount3 || 0;
                pcsIncreaserCost3 = gameState.pcsIncreaserCost3 || INITIAL_COST_3;
                isAutoPurchaseEnabled = gameState.isAutoPurchaseEnabled === true;

                if (gameState.permUpgrades) {
                    for (const key in gameState.permUpgrades) {
                        if (PERM_UPGRADES[key]) {
                            PERM_UPGRADES[key].purchased = gameState.permUpgrades[key];
                        }
                    }
                }
            } else {
                money = 0;
                pcsIncreaserCount1 = 0;
                pcsIncreaserCost1 = INITIAL_COST_1;
                pcsIncreaserCount2 = 0;
                pcsIncreaserCost2 = INITIAL_COST_2;
                pcsIncreaserCount3 = 0;
                pcsIncreaserCost3 = INITIAL_COST_3;
                isAutoPurchaseEnabled = false;
                for (const key in PERM_UPGRADES) {
                    PERM_UPGRADES[key].purchased = false;
                }
            }
            
            applyAllPermanentEffects();
            recalculateTotalPcs(); 
            updateAutoPurchaseButton();
            updateDisplay(); 
        }

        function resetGame() {
            localStorage.removeItem(STORAGE_KEY);
            loadGame(); 
            if (autoPurchaseInterval) {
                stopAutoPurchaseLoop();
            }
            scheduleNextSpawn();
            settingsModal.classList.add('hidden');
            confirmationModal.classList.add('hidden');
        }

        function updateAutoPurchaseButton() {
            if (isAutoPurchaseEnabled) {
                toggleAutoPurchaseButton.textContent = 'ON';
                toggleAutoPurchaseButton.classList.remove('bg-gray-500', 'hover:bg-gray-400');
                toggleAutoPurchaseButton.classList.add('bg-lime-500', 'hover:bg-lime-400', 'text-blue-900');
                startAutoPurchaseLoop();
            } else {
                toggleAutoPurchaseButton.textContent = 'OFF';
                toggleAutoPurchaseButton.classList.remove('bg-lime-500', 'hover:bg-lime-400', 'text-blue-900');
                toggleAutoPurchaseButton.classList.add('bg-gray-500', 'hover:bg-gray-400');
                stopAutoPurchaseLoop();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadGame();
            startGameLoop();
            scheduleNextSpawn();
            
            const storeContainer = document.getElementById('store-content-container');
            for (const key in PERM_UPGRADES) {
                const upgrade = PERM_UPGRADES[key];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex flex-col sm:flex-row justify-between items-center bg-blue-700/70 p-4 rounded-lg shadow-inner shadow-blue-900/50 hover:bg-blue-600/70 transition duration-200';
                itemDiv.innerHTML = `
                    <div class="mb-2 sm:mb-0 text-center sm:text-left">
                        <p class="text-xl font-bold">${upgrade.name}</p>
                        <p class="text-sm text-fuchsia-300 font-mono mt-0.5">${upgrade.desc}</p>
                    </div>
                    <button 
                        id="${upgrade.id}" 
                        class="buy-perm-button w-full sm:w-auto px-6 py-2 bg-amber-500 hover:bg-amber-400 rounded-xl font-bold text-blue-900 transition duration-150 shadow-lg disabled:opacity-30 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
                        data-upgrade-key="${key}"
                    >
                        <span>${formatCost(upgrade.cost)} Pibbcoins</span>
                    </button>
                `;
                storeContainer.appendChild(itemDiv);
            }
            
            document.querySelectorAll('.buy-perm-button').forEach(button => {
                button.addEventListener('click', () => {
                    buyPermanentUpgrade(button.dataset.upgradeKey);
                });
            });
            
            checkButtonStates();
        });


        clickerSquare.addEventListener('mousedown', () => {
            clickerSquare.classList.add('clicked');
            clickerSquare.src = CLICK_DOWN_IMAGE_SRC;
        });

        clickerSquare.addEventListener('mouseup', () => {
            clickerSquare.classList.remove('clicked');
            clickerSquare.src = DEFAULT_IMAGE_SRC;
            handleMainClick();
        });

        clickerSquare.addEventListener('mouseleave', () => {
            clickerSquare.classList.remove('clicked');
            clickerSquare.src = DEFAULT_IMAGE_SRC;
        });


        buyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tier = parseInt(button.dataset.tier);
                buyPibbleWasher(tier);
                updateDisplay();
            });
        });
        
        settingsButton.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
        });

        closeSettingsButton.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });
        
        saveButton.addEventListener('click', saveGame);
        
        restartButton.addEventListener('click', () => {
            confirmationText.textContent = 'Are you sure you want to restart? All progress will be lost.';
            confirmActionButton.textContent = 'Yes, Restart';
            confirmActionButton.onclick = resetGame;
            confirmationModal.classList.remove('hidden');
        });

        cancelActionButton.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
        });
        
        toggleAutoPurchaseButton.addEventListener('click', () => {
            isAutoPurchaseEnabled = !isAutoPurchaseEnabled;
            updateAutoPurchaseButton();
        });
        
        document.addEventListener('keydown', (event) => {
            if (event.key === 'F9') {
                event.preventDefault();
                window.open('https://fed.education.qld.gov.au/idp/SSO.saml2?SAMLRequest=fVJbT8IwFH73Vyx9X3eBwdIACUKMJCiETR98MaU7gyZdO3pB%2Ffd2QyM%2B6OvX73bO6cTQRrRk7uxR7uDkwNjgvRHSkP5hipyWRFHDDZG0AUMsI8X8YU1SHJNWK6uYEuhK8r%2BCGgPaciVRsFpO0Ws2qigM8jwcZOM8HOZ7CPf1iIUJZGmSs3GcMoaCZ9DGa6bIW3ihMQ5W0lgqrYfiNAuTNIyHZTwmyZgM8xcULP0cXFLbq47WtoZEUQ0VhsqxHsYnUeGDOmPqIl61UVFscNc%2FRcH8u%2BRCSeMa0AXoM2fwtFv%2FmJ0EUC0xnDrLzkSoA5dRZ4GC7ddibrmsuDz8v5P9hWTIfVluw%2B2mKNFs0vmQflI96yK7RF%2Bf%2B7G1Y9ZpwEw1fVw6ia7Zk8tFH33OarlVgrOP4E7phtq%2FayQ46RFehXVPJU6aFhivOVR%2BIUKot4UGamGKfD6gaHYJ%2Ff1zZjef', '_blank'); // Open Google in a new tab
            }
        });
    </script>
</body>
</html>
